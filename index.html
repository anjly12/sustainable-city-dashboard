<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sustainable City Health ‚Äî Single Location</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Geocoder (search any location) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

  <style>
    :root{--bg:#f6f9fb;--card:#fff;--muted:#6b7280;--accent:#0ea5a4}
    body{margin:0;font-family:Inter,Segoe UI,Helvetica,Arial;background:var(--bg);color:#0f1724}
    .wrap{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .tabs{display:flex;gap:8px;margin:16px 0}
    .tab{padding:8px 12px;border-radius:8px;background:var(--card);cursor:pointer;border:1px solid rgba(15,23,36,0.06)}
    .tab.active{box-shadow:0 6px 20px rgba(2,6,23,0.06);border-color:var(--accent);background:var(--accent);color:#fff}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:16px}
    .panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    #map{height:480px;border-radius:10px}
    #charts{display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px}
    #mainChart{height:360px}
    #secondaryChart{height:360px}
    label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
    .metricRow{display:flex;gap:8px;margin-top:8px}
    .metric{flex:1;background:#f8fafc;padding:10px;border-radius:8px;text-align:center}
    .metric .v{font-size:18px;font-weight:700}
    .insights{margin-top:12px;color:var(--muted)}
    footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8}
    @media(max-width:980px){.layout{grid-template-columns:1fr}.tabs{flex-wrap:wrap}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üåç Sustainable City Health ‚Äî Select Any Location</h1>
        <div style="color:var(--muted);font-size:13px">Click anywhere on the map or use the search box to pick a location. Charts update for the selected point.</div>
      </div>
      <div style="text-align:right">
        <div style="color:var(--muted);font-size:13px">Selected</div>
        <div id="selName" style="font-weight:700">No location selected</div>
        <div id="selCoords" style="font-size:12px;color:var(--muted)"></div>
      </div>
    </header>

    <div style="margin-top:12px">
      <div class="tabs">
        <div class="tab active" data-tab="air">üèôÔ∏è Air</div>
        <div class="tab" data-tab="water">üíß Water</div>
        <div class="tab" data-tab="waste">‚ôªÔ∏è Waste</div>
      </div>
    </div>

    <div class="layout">
      <div class="panel" style="display:flex;flex-direction:column;gap:10px">
        <label for="search">Search any location (city, address, landmark)</label>
        <input type="text" id="search" placeholder="Type a place">

        <div style="display:flex;gap:8px;align-items:center">
          <label style="margin:0">Timespan (simulated history)</label>
          <select id="timespan" style="margin-left:auto;padding:6px;border-radius:8px;">
            <option value="7">7 days</option>
            <option value="14" selected>14 days</option>
            <option value="30">30 days</option>
          </select>
        </div>

        <div class="metricRow">
          <div class="metric">
            <div style="font-size:12px;color:var(--muted)">Primary Metric</div>
            <div id="mPrimary" class="v">‚Äî</div>
          </div>
          <div class="metric">
            <div style="font-size:12px;color:var(--muted)">Secondary</div>
            <div id="mSecondary" class="v">‚Äî</div>
          </div>
          <div class="metric">
            <div style="font-size:12px;color:var(--muted)">Tertiary</div>
            <div id="mTertiary" class="v">‚Äî</div>
          </div>
        </div>

        <div class="insights panel" style="padding:10px">
          <strong>Insight</strong>
          <div id="insightText" style="margin-top:8px;color:var(--muted)">Select a location to get contextual advice.</div>
        </div>

        <div style="flex:1"></div>
        <div style="font-size:12px;color:var(--muted);text-align:center">Simulated historical values follow standard ranges for realistic demo.</div>
      </div>

      <div>
        <div id="map" class="panel"></div>

        <div id="charts" style="margin-top:12px">
          <div id="mainChart" class="panel"></div>
          <div id="secondaryChart" class="panel"></div>
        </div>

        <footer>Demo ‚Äî replace simulated generator with real sensors/APIs (OpenAQ, NASA, municipal)</footer>
      </div>
    </div>
  </div>

<script>
/* -------------------------
   Utility random generators with fixed ranges (realistic)
   -------------------------*/

function generateAirSeries(days) {
  // PM2.5 range 0-500, CO2 300-2000, AQI 0-500 (approx)
  const arr = [];
  for (let i=days-1;i>=0;i--) {
    // some diurnal/random variation
    const pm25 = Math.round(Math.max(0, 5 + Math.random()*120)); // keep lower for demo
    const co2 = Math.round(350 + Math.random()*1000);
    const aqi = Math.round(0.6*pm25 + co2/10 + (10+Math.random()*20)/2); // similar to earlier formula
    const date = new Date(); date.setDate(date.getDate()-i);
    arr.push({date: date.toISOString().slice(0,10), pm25, co2, aqi});
  }
  return arr;
}

function generateWaterSeries(days) {
  // pH 6.0 - 8.5, turbidity 0-100 NTU, DO 0-14 mg/L, WQI computed 0-100
  const arr = [];
  for (let i=days-1;i>=0;i--) {
    const pH = Math.round((6 + Math.random()*2.5)*10)/10;
    const turbidity = Math.round(Math.random()*80);
    const DO = Math.round((3 + Math.random()*8)*10)/10;
    const WQI = Math.round((pH*12.5 + (100 - turbidity) + DO*12.5)/3);
    const date = new Date(); date.setDate(date.getDate()-i);
    arr.push({date: date.toISOString().slice(0,10), pH, turbidity, DO, WQI});
  }
  return arr;
}

function generateWasteSeries(days) {
  // waste level 0-100%, recycling 0-100%, CO2 saved approx recycling*1.8
  const arr = [];
  for (let i=days-1;i>=0;i--) {
    const wasteLevel = Math.round(Math.random()*100);
    const recyclingRate = Math.round(Math.random()*80);
    const co2Saved = Math.round(recyclingRate * 1.8);
    const date = new Date(); date.setDate(date.getDate()-i);
    arr.push({date: date.toISOString().slice(0,10), wasteLevel, recyclingRate, co2Saved});
  }
  return arr;
}

/* -------------------------
   Map + geocoder + click
   -------------------------*/

const map = L.map('map').setView([9.55, 76.33], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

// add geocoder search control (global search)
const geocoder = L.Control.geocoder({defaultMarkGeocode: false}).addTo(map);

let selectedMarker = null;
let selectedLocation = null; // {name, lat, lng}
let historyData = {}; // stores recently generated series for reuse if desired

// When user searches with geocoder (top-right control)
geocoder.on('markgeocode', function(e) {
  const center = e.geocode.center;
  const name = e.geocode.name || `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
  selectLocation(name, center.lat, center.lng);
  // fit to result
  map.setView(center, 13);
});

// Also allow manual map click to pick any point
map.on('click', function(e) {
  selectLocation('Manual selection', e.latlng.lat, e.latlng.lng);
});

/* Also wire the text search box: user types and presses Enter -> use geocoder's geocode */
document.getElementById('search').addEventListener('keydown', function(evt){
  if (evt.key === 'Enter') {
    const q = this.value.trim();
    if (!q) return;
    // use geocoder's backend
    // Control.Geocoder.Nominatim is available; use it
    if (L.Control.Geocoder && L.Control.Geocoder.nominatim) {
      const geoc = L.Control.Geocoder.nominatim();
      geoc.geocode(q, function(results){
        if (results && results.length>0) {
          const r = results[0];
          const center = r.center;
          selectLocation(r.name || q, center.lat, center.lng);
          map.setView(center, 13);
        } else {
          alert('Location not found. Try a different query.');
        }
      });
    } else {
      alert('Geocoder not available.');
    }
  }
});

/* -------------------------
   Tab switching (Air/Water/Waste)
   -------------------------*/
let activeTab = 'air';
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  activeTab = t.dataset.tab;
  if (selectedLocation) updateChartsForLocation(selectedLocation);
}));

/* -------------------------
   Core: when location selected
   - put marker, simulate series with chosen timespan, update charts + metrics + insight
   -------------------------*/
function selectLocation(name, lat, lng) {
  selectedLocation = {name, lat, lng};
  // update header display
  document.getElementById('selName').textContent = name;
  document.getElementById('selCoords').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;

  // move marker
  if (selectedMarker) map.removeLayer(selectedMarker);
  selectedMarker = L.circleMarker([lat,lng], {radius:8, color:'#0ea5a4', fillColor:'#0ea5a4', fillOpacity:0.9}).addTo(map)
    .bindPopup(`<strong>${name}</strong><br>${lat.toFixed(5)}, ${lng.toFixed(5)}`).openPopup();

  // generate or reuse simulated time series according to timespan
  const days = parseInt(document.getElementById('timespan').value, 10);
  // key by rounded coords or name to store in historyData if wanted
  const key = `${lat.toFixed(3)}_${lng.toFixed(3)}_${days}`;
  if (!historyData[key]) {
    historyData[key] = {
      air: generateAirSeries(days),
      water: generateWaterSeries(days),
      waste: generateWasteSeries(days)
    };
  }
  // update charts for currently active tab
  updateChartsForLocation(selectedLocation);
}

/* -------------------------
   Update charts & metric cards for the selected location
   -------------------------*/
function updateChartsForLocation(loc) {
  if (!loc) return;
  const days = parseInt(document.getElementById('timespan').value, 10);
  const key = `${loc.lat.toFixed(3)}_${loc.lng.toFixed(3)}_${days}`;
  const data = historyData[key] || {
    air: generateAirSeries(days),
    water: generateWaterSeries(days),
    waste: generateWasteSeries(days)
  };

  // pick the series for the active tab
  if (activeTab === 'air') {
    const s = data.air;
    const dates = s.map(d=>d.date);
    const traceAQI = {x:dates, y:s.map(d=>d.aqi), name:'AQI', mode:'lines+markers', line:{width:2}};
    const tracePM = {x:dates, y:s.map(d=>d.pm25), name:'PM2.5 (¬µg/m¬≥)', yaxis:'y2', mode:'lines+markers', line:{width:2}};
    const traceCO2 = {x:dates, y:s.map(d=>d.co2), name:'CO‚ÇÇ (ppm)', yaxis:'y3', mode:'lines+markers', line:{width:2}};
    const layout = {
      title: `Air Quality at ${loc.name}`,
      margin:{t:40},
      yaxis:{title:'AQI'},
      yaxis2:{title:'PM2.5', overlaying:'y', side:'right'},
      yaxis3:{title:'CO‚ÇÇ', overlaying:'y', side:'right', position:0.95}
    };
    Plotly.newPlot('mainChart', [traceAQI, tracePM, traceCO2], layout, {displayModeBar:false});

    // secondary: latest snapshot
    const latest = s[s.length-1];
    Plotly.newPlot('secondaryChart', [{x:['AQI','PM2.5','CO‚ÇÇ'], y:[latest.aqi, latest.pm25, latest.co2], type:'bar'}], {title:'Latest Air Metrics'}, {displayModeBar:false});

    // update metrics cards
    document.getElementById('mPrimary').textContent = `AQI ${latest.aqi}`;
    document.getElementById('mSecondary').textContent = `${latest.pm25} ¬µg/m¬≥`;
    document.getElementById('mTertiary').textContent = `${latest.co2} ppm`;

    // insight
    let insight = '';
    if (latest.aqi > 150) insight = 'Very unhealthy ‚Äî limit outdoor activities.';
    else if (latest.aqi > 100) insight = 'Unhealthy for sensitive groups. Take precautions.';
    else if (latest.aqi > 50) insight = 'Moderate air quality.';
    else insight = 'Good air quality.';

    document.getElementById('insightText').textContent = insight;
  }

  if (activeTab === 'water') {
    const s = data.water;
    const dates = s.map(d=>d.date);
    const traceWQI = {x:dates, y:s.map(d=>d.WQI), name:'WQI', mode:'lines+markers', line:{width:2}};
    const tracePH = {x:dates, y:s.map(d=>d.pH), name:'pH', yaxis:'y2', mode:'lines+markers', line:{width:2}};
    const traceTurb = {x:dates, y:s.map(d=>d.turbidity), name:'Turbidity (NTU)', yaxis:'y3', mode:'lines+markers', line:{width:2}};
    const traceDO = {x:dates, y:s.map(d=>d.DO), name:'DO (mg/L)', yaxis:'y4', mode:'lines+markers', line:{width:2}};
    const layout = {
      title: `Water Quality at ${loc.name}`,
      margin:{t:40},
      yaxis:{title:'WQI'},
      yaxis2:{title:'pH', overlaying:'y', side:'right'},
      yaxis3:{title:'Turbidity', overlaying:'y', side:'left', position:0.05},
      yaxis4:{title:'DO', overlaying:'y', side:'right', position:0.95}
    };
    Plotly.newPlot('mainChart', [traceWQI, tracePH, traceTurb, traceDO], layout, {displayModeBar:false});

    const latest = s[s.length-1];
    Plotly.newPlot('secondaryChart', [{x:['WQI','pH','Turbidity','DO'], y:[latest.WQI, latest.pH, latest.turbidity, latest.DO], type:'bar'}], {title:'Latest Water Metrics'}, {displayModeBar:false});

    document.getElementById('mPrimary').textContent = `WQI ${latest.WQI}`;
    document.getElementById('mSecondary').textContent = `pH ${latest.pH}`;
    document.getElementById('mTertiary').textContent = `Turbidity ${latest.turbidity} NTU`;

    let insight = '';
    if (latest.WQI < 50) insight = 'Poor water quality ‚Äî avoid direct consumption.';
    else if (latest.WQI < 70) insight = 'Moderate water quality ‚Äî monitoring required.';
    else insight = 'Good water quality.';
    document.getElementById('insightText').textContent = insight;
  }

  if (activeTab === 'waste') {
    const s = data.waste;
    const dates = s.map(d=>d.date);
    const traceWaste = {x:dates, y:s.map(d=>d.wasteLevel), name:'Waste Level (%)', mode:'lines+markers', line:{width:2}};
    const traceRecycle = {x:dates, y:s.map(d=>d.recyclingRate), name:'Recycling Rate (%)', yaxis:'y2', mode:'lines+markers', line:{width:2}};
    const traceCO2 = {x:dates, y:s.map(d=>d.co2Saved), name:'CO‚ÇÇ Saved (kg)', yaxis:'y3', mode:'lines+markers', line:{width:2}};
    const layout = {
      title: `Waste Management at ${loc.name}`,
      margin:{t:40},
      yaxis:{title:'Waste Level (%)'},
      yaxis2:{title:'Recycling (%)', overlaying:'y', side:'right'},
      yaxis3:{title:'CO‚ÇÇ Saved', overlaying:'y', side:'left', position:0.05}
    };
    Plotly.newPlot('mainChart', [traceWaste, traceRecycle, traceCO2], layout, {displayModeBar:false});

    const latest = s[s.length-1];
    Plotly.newPlot('secondaryChart', [{labels:['Filled','Empty'], values:[latest.wasteLevel, 100-latest.wasteLevel], type:'pie'}], {title:'Bin Fill (%)'}, {displayModeBar:false});

    document.getElementById('mPrimary').textContent = `Filled ${latest.wasteLevel}%`;
    document.getElementById('mSecondary').textContent = `Recycle ${latest.recyclingRate}%`;
    document.getElementById('mTertiary').textContent = `${latest.co2Saved} kg CO‚ÇÇ`;

    let insight = '';
    if (latest.wasteLevel > 85) insight = 'Bins nearly full ‚Äî schedule immediate pickup.';
    else if (latest.wasteLevel > 60) insight = 'Bins filling up ‚Äî monitor route.';
    else insight = 'Waste levels under control.';
    document.getElementById('insightText').textContent = insight;
  }
}

/* -------------------------
   When timespan changed, regenerate series for the selected location
   -------------------------*/
document.getElementById('timespan').addEventListener('change', function(){
  if (!selectedLocation) return;
  // clear old key so new series generated and saved
  const loc = selectedLocation;
  const days = parseInt(this.value,10);
  const key = `${loc.lat.toFixed(3)}_${loc.lng.toFixed(3)}_${days}`;
  delete historyData[key];
  selectLocation(loc.name, loc.lat, loc.lng); // regenerate and update
});

/* -------------------------
   initial help message in charts
   -------------------------*/
Plotly.newPlot('mainChart', [{x:[0], y:[0], mode:'lines'}], {title:'Select a location to view data'}, {displayModeBar:false});
Plotly.newPlot('secondaryChart', [{x:[0], y:[0], type:'bar'}], {title:'Metrics'}, {displayModeBar:false});

/* -------------------------
   End of script
   -------------------------*/
</script>
</body>
</html>
